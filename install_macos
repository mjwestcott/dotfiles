#!/usr/bin/env bash
#
# Install bash and zsh dotfiles environment on macOS.

if [[ $(uname -s) != 'Darwin' ]]; then
    echo "Error: not on macOS"
    exit 1
elif [[ ! -e ~/dotfiles ]]; then
    echo "Error: ~/dotfiles does not exist"
    exit 1
elif [[ -s ~/dotfiles/backup ]]; then # Don't clobber an old backup
    echo "Error: ~/dotfiles/backup already exists"
    exit 1
fi

# Trackpad: enable tap to click for this user and for the login screen
defaults write com.apple.driver.AppleBluetoothMultitouch.trackpad Clicking -bool true
defaults -currentHost write NSGlobalDomain com.apple.mouse.tapBehavior -int 1
defaults write NSGlobalDomain com.apple.mouse.tapBehavior -int 1

# Homebrew
[[ -z "$(which brew)" ]] && ruby -e "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install)"
brew update
brew upgrade
brew tap caskroom/cask
brew install ag
brew install awscli
brew install bash
brew install bash-completion@2
brew install cmake
brew install coreutils
brew install ctags
brew install devd
brew install fasd
brew install git
brew install gnuplot
brew install go
brew install graphviz
brew install heroku/brew/heroku
brew install httpie
brew install jq
brew install macvim --HEAD --with-override-system-vim
brew install memcached
brew install modd
brew install mysql
brew install opam
brew install postgresql
brew install python
brew install python@2
brew install rabbitmq
brew install ranger
brew install rbenv
brew install reattach-to-user-namespace
brew install redis
brew install shellcheck
brew install sqlite
brew install tmux
brew install tree
brew install wget
brew install youtube-dl
brew install zsh

# Docker
brew cask install docker
brew install docker-completion
brew install docker-compose-completion
brew install docker-machine-completion

# SF Mono
cp /Applications/Utilities/Terminal.app/Contents/Resources/Fonts/* ~/Library/Fonts

# Rust config
curl https://sh.rustup.rs -sSf | sh \
    && source "$HOME/.cargo/env" \
    && rustup override set stable \
    && rustup update stable

# Alacritty
git clone https://github.com/jwilm/alacritty.git ~/alacritty \
    && pushd ~/alacritty \
    && make app \
    && cp -rv target/release/osx/Alacritty.app /Applications/ \
    && popd || exit 1

# OCaml config
opam init
opam switch 4.06.0
eval "$(opam config env)"
opam install merlin ocp-indent tuareg utop

# Python config
sudo pip install --upgrade pip
sudo pip install virtualenvwrapper && mkdir -pv ~/repos/python
sudo pip install 'ipython[all]'

# Ruby config
rbenv install 2.5.0 && rbenv global 2.5.0

# Prezto
if [[ ! -e ~/.zprezto ]]; then
    git clone --recursive git@github.com:mjwestcott/prezto.git ~/.zprezto
fi

# git-prompt
if [[ ! -e ~/.git-prompt.sh ]]; then
    curl https://raw.githubusercontent.com/git/git/master/contrib/completion/git-prompt.sh -o ~/.git-prompt.sh
fi

# Dotfiles
cd ~/dotfiles && mkdir -pv backup
for path in shell/bash/* shell/zsh/* readline/* git/* vim/*rc tmux/tmux.conf ag/agignore; do
    file=$(basename "$path")
    [[ -e "$HOME/.$file" ]] && mv -v "$HOME/.$file" "backup/$file"
    ln -sfv "$HOME/dotfiles/$path" "$HOME/.$file"
done

cd ~/dotfiles/vim/colors && mkdir -pv ~/.vim/colors
for file in *; do
    [[ ! -e ~/.vim/colors/$file ]] && ln -sfv "$HOME/dotfiles/vim/colors/$file" "$HOME/.vim/colors/$file"
done

mkdir -pv ~/.config/alacritty && ln -sfv ~/dotfiles/alacritty/alacritty_macos.yml ~/.config/alacritty/alacritty.yml

cd ~/dotfiles/bin && mkdir -pv ~/bin
for file in *; do
    [[ ! -e ~/bin/$file ]] && ln -sfv "$HOME/dotfiles/bin/$file" "$HOME/bin/$file"
done

# Tmux Package Manager
git clone https://github.com/tmux-plugins/tpm ~/.tmux/plugins/tpm \
    && sudo ~/.tmux/plugins/tpm/bin/install_plugins
