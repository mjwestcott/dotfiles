#!/usr/bin/env bash
#
# Install bash and zsh dotfiles environment on macOS.

if [[ $(uname -s) != 'Darwin' ]]; then
    echo "Error: not on macOS"
    exit 1
elif [[ ! -e ~/dotfiles ]]; then
    echo "Error: ~/dotfiles does not exist"
    exit 1
elif [[ -s ~/dotfiles/backup ]]; then # Don't clobber an old backup
    echo "Error: ~/dotfiles/backup already exists"
    exit 1
fi

[[ -z "$(which brew)" ]] && ruby -e "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install)"
brew update
brew upgrade
brew tap caskroom/cask
brew install ag
brew install awscli
brew install bash
brew install bash-completion@2
brew install cmake
brew install coreutils
brew install ctags
brew install devd
brew install fasd
brew install git
brew install gnuplot
brew install go
brew install graphviz
brew install heroku/brew/heroku
brew install httpie
brew install jq
brew install macvim --HEAD --with-override-system-vim
brew install memcached
brew install modd
brew install mysql
brew install opam
brew install postgresql
brew install python
brew install python@2
brew install rabbitmq
brew install ranger
brew install reattach-to-user-namespace
brew install redis
brew install rbenv
brew install shellcheck
brew install sqlite
brew install tmux
brew install tree
brew install wget
brew install youtube-dl
brew install zsh

# Docker
brew cask install docker
brew install docker-completion
brew install docker-compose-completion
brew install docker-machine-completion

# OCaml config
opam init
opam switch 4.03.0
eval `opam config env`
opam install merlin ocp-indent tuareg utop

# Python config
sudo pip install --upgrade pip
sudo pip install virtualenvwrapper && mkdir -pv ~/repos/python
sudo pip install 'ipython[all]'

# Ruby config
rbenv install 2.3.1
rbenv global 2.3.1

# Prezto
git clone --recursive git@github.com:mjwestcott/prezto.git ~/.zprezto

# git-prompt
if [[ ! -e ~/.git-prompt.sh ]]; then
    curl https://raw.githubusercontent.com/git/git/master/contrib/completion/git-prompt.sh -o ~/.git-prompt.sh
fi

# dotfiles
cd ~/dotfiles && mkdir -pv backup
for path in shell/bash/* shell/zsh/* readline/* git/* vim/*rc tmux/tmux.conf ag/agignore; do
    file=$(basename $path)
    [[ -e ~/.$file ]] && mv -v ~/.$file backup/.$file
    ln -sfv ~/dotfiles/$path ~/.$file
done

# ipython
mkdir -pv  ~/.ipython/profile_default/startup
if [[ -e ~/.ipython/profile_default/ipython_config.py ]]; then
    mv -v ~/.ipython/profile_default/ipython_config.py backup/ipython_config
fi
if [[ -e ~/.ipython/profile_default/startup/00-imports.py ]]; then
    mv -v ~/.ipython/profile_default/startup/00-imports.py backup/00-imports.py
fi
ln -sfv ~/dotfiles/ipython/ipython_config.py ~/.ipython/profile_default/ipython_config.py
ln -sfv ~/dotfiles/ipython/startup/00-imports.py ~/.ipython/profile_default/startup/00-imports.py

# pgcli
mkdir -pv ~/.config/pgcli
[[ -e ~/.config/pgcli/config ]] && mv -v ~/.config/pgcli/config backup/pgcli_config
ln -sfv ~/dotfiles/pgcli/config ~/.config/pgcli/config

# vim
cd ~/dotfiles/vim/colors && mkdir -pv ~/.vim/colors
for file in *; do
    [[ ! -e ~/.vim/colors/$file ]] && ln -sfv ~/dotfiles/vim/colors/$file ~/.vim/colors/$file
done

# Tmux Package Manager
git clone https://github.com/tmux-plugins/tpm ~/.tmux/plugins/tpm
sudo ~/.tmux/plugins/tpm/bin/install_plugins
